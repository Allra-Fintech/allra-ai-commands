# PR 리뷰 코멘트 처리 워크플로우

PR에 달린 리뷰 코멘트를 분석하고, 사용자와 함께 검토하여 반영/미반영을 결정한 후 코드를 수정합니다.

## 인자
- `$ARGUMENTS`: PR 번호 (생략 시 현재 브랜치의 PR 자동 탐지)

## 워크플로우

### 1단계: PR 탐지 및 코멘트 수집
- PR 번호가 주어지지 않은 경우:
  - 현재 브랜치 확인
  - `gh pr list --head {현재브랜치}`로 PR 번호 탐지
  - PR이 없으면 사용자에게 알리고 종료
- PR 번호가 주어진 경우:
  - 해당 PR 존재 여부 확인
- `gh api repos/{owner}/{repo}/pulls/{prNumber}/comments`로 리뷰 코멘트 수집
- `gh pr view {prNumber} --comments`로 일반 코멘트도 수집

### 2단계: 코멘트 분석 및 분류
- 수집된 코멘트를 다음 기준으로 분류:
  - **Actionable**: 코드 변경이 필요한 피드백
  - **Nitpick**: 선택적 개선 제안
  - **Question**: 질문 또는 확인 요청
  - **Resolved**: 이미 처리된 코멘트 (제외)
- 각 코멘트에 대해 분석:
  - 대상 파일 및 라인
  - 변경 필요 여부 및 이유
  - 비즈니스 요구사항과의 충돌 여부
  - 제안되는 변경 방안

### 3단계: 분석 결과 보고 (사용자 확인)
다음 형식으로 정리하여 사용자에게 보여주기:

```
## PR #{prNumber} 리뷰 코멘트 분석 결과

### 반영 예정 ({n}건)
| # | 파일 | 코멘트 요약 | 변경 방안 |
|---|------|------------|----------|
| 1 | file.java:42 | 시계 일관성 문제 | LocalDateTime에서 파생 |
| ... | ... | ... | ... |

### 반영 안 함 ({m}건)
| # | 파일 | 코멘트 요약 | 미반영 사유 |
|---|------|------------|------------|
| 1 | file.java:80 | 유니크 제약조건 추가 | 비즈니스 요구사항 불일치 |
| ... | ... | ... | ... |

### 추가 검토 필요 ({k}건)
| # | 파일 | 코멘트 요약 | 질문 |
|---|------|------------|------|
| ... | ... | ... | ... |
```

**반드시 사용자에게 다음을 확인받기:**
- 반영 예정 항목들이 맞는지
- 미반영 항목들의 사유가 적절한지
- 추가 검토 필요 항목에 대한 방향

### 4단계: 미반영 코멘트에 대댓글 등록
- 미반영으로 결정된 코멘트에 대해:
  - `@coderabbitai` (또는 해당 리뷰어) 태그
  - 미반영 사유를 명확하게 설명
  - `gh api repos/{owner}/{repo}/pulls/{prNumber}/comments -X POST -F in_reply_to={commentId} -f body='{사유}'`

### 5단계: 코드 변경 적용
- 반영 예정 항목들을 순차적으로 적용
- 각 변경 후 컴파일 오류 여부 간단히 확인
- 모든 변경사항을 **하나의 커밋**으로 묶어서 커밋
- 커밋 메시지 형식:
  ```
  fix: PR 리뷰 피드백 반영

  - {변경사항 1 요약}
  - {변경사항 2 요약}
  - ...

  🤖 Generated with [Claude Code](https://claude.com/claude-code)

  Co-Authored-By: Claude <noreply@anthropic.com>
  ```

### 6단계: 빌드 및 테스트
- 프로젝트 빌드 실행
- 테스트 실행
- **실패 시**:
  - 사용자에게 실패 내용 보고
  - 선택지 제공:
    - A) 문제 수정 후 재시도
    - B) 변경사항 롤백
    - C) 그대로 푸시 (위험)
  - 사용자 선택에 따라 진행

### 7단계: 푸시
- 빌드/테스트 성공 시 (또는 사용자가 푸시 선택 시)
- `git push` 실행
- 완료 요약 보고

## 주의사항
- **항상 사용자의 확인을 받고 진행**: 자동으로 코드 변경이나 푸시를 하지 않음
- 비즈니스 로직 관련 코멘트는 반드시 사용자에게 확인
- 대댓글 등록 시 `@{리뷰어}` 태그로 알림 전달
- 이미 resolved된 코멘트는 건너뛰기

## 사용 예시
```
/pr-feedback           # 현재 브랜치 PR의 리뷰 코멘트 처리
/pr-feedback 58        # PR #58의 리뷰 코멘트 처리
```

## 관련 명령어
- `/pr-create`: PR 생성 워크플로우
